JIRA.ViewIssueTabs=(function(){var useHistoryApi=AJS.Meta.get("viewissue-use-history-api")!==false;var AJAX_LOAD_CLASS="ajax-activity-content";var CONTAINER_SELECTOR="#activitymodule div.mod-content";var AJAX_LINK_SELECTOR=AJS.format("a.{0}",AJAX_LOAD_CLASS);var issueTabLoadedListeners=[];var $tabWrapper,$tabContents;var xhrInProgress;function dispatchIssueTabLoadedEvent(container){container=container||document;AJS.$.each(issueTabLoadedListeners,function(i,fn){fn(container)})}function bindToTabDivs(container){var $newTabWrapper=AJS.$(container).find(".issuePanelWrapper");var $newTabContents=AJS.$(container).find("#issue_actions_container");$tabContents=$newTabContents.length?$newTabContents:$tabContents;$tabWrapper=$newTabWrapper.length?$newTabWrapper:$tabWrapper}function dispatchIssueTabErrorEvent(smartAjaxResult,activeTabKey){var errorPopup=new JIRA.FormDialog({id:"issue-tab-error-dialog",widthClass:"small",content:JIRA.SmartAjax.buildDialogErrorContent(smartAjaxResult,false)});setActiveTab(activeTabKey);$tabContents.show();errorPopup.show()}function setActiveTab(activeTabKey){AJS.$("#issue-tabs li").each(function(){var $li=AJS.$(this);var tabKey=$li.data("key");var labelHtml=AJS.format("<strong>{0}</strong>",$li.data("label"));if(tabKey==activeTabKey){$li.addClass("active");$li.html(labelHtml)}else{$li.removeClass("active");var id=$li.data("id");var href=$li.data("href");$li.html(AJS.format('<a id="{0}" href="{1}" class="{2}">{3}</a>',id,href,AJAX_LOAD_CLASS,labelHtml))}});enableAjaxOnLinks(AJS.$("#issue-tabs"))}function putTabInLoadingState(activeTabKey){setActiveTab(activeTabKey)}function isTriggerByKeyBoard(event,$trigger){var eventX=event.pageX;var eventY=event.pageY;var triggerOffset=$trigger.offset();var triggerWidth=$trigger.outerWidth();var triggerHeight=$trigger.outerHeight();if(eventX==0&&eventY==0){return true}else{return !(eventX>=triggerOffset.left&&eventX<=(triggerOffset.left+triggerWidth)&&eventY>=triggerOffset.top&&eventY<=(triggerOffset.top+triggerHeight))}}function enableAjaxOnLinks(context){var activeTabKey=AJS.$(context).find("li.active").data("key");AJS.$(context).find(AJAX_LINK_SELECTOR).click(function(event){if(event.metaKey){return }event.preventDefault();var $trigger=AJS.$(this);var isTriggerByKeyboard=isTriggerByKeyBoard(event,$trigger);var loadingTabKey=$trigger.parent().data("key");if(loadingTabKey){putTabInLoadingState(loadingTabKey)}handleAjaxContentsLoading(activeTabKey,$trigger.attr("href")).done(function($container){if(!isTriggerByKeyboard){return }if(loadingTabKey){$container.find("#"+$trigger.attr("id")+" > :first-child").focus()}else{$container.find(".sortwrap  > :first-child").focus()}}).done(dispatchIssueTabLoadedEvent)})}function handleAjaxContentsLoading(activeTabKey,loadingUrl){var deferred=jQuery.Deferred();if(xhrInProgress){xhrInProgress.abort()}var xhr=JIRA.SmartAjax.makeRequest({jqueryAjaxFn:useHistoryApi?AJS.$.pjax:AJS.$.ajax,headers:{"X-PJAX":true},container:CONTAINER_SELECTOR,url:loadingUrl,timeout:null,complete:function(xhr,status,smartAjaxResult){if(status!="abort"){xhrInProgress=null;if(!smartAjaxResult.successful){if(smartAjaxResult.status<300||smartAjaxResult.status>=400){dispatchIssueTabErrorEvent(smartAjaxResult,activeTabKey)}return }var $container=AJS.$(this.container);var newElementsHtml=document.createElement("div");newElementsHtml.innerHTML=smartAjaxResult.data;var newElements=document.createDocumentFragment().appendChild(newElementsHtml);if(!useHistoryApi){smartUpdate($container,newElements)}JIRA.trace("jira.issue.tab.loaded");deferred.resolve($container)}}});jQuery(xhr).throbber({target:$tabWrapper});xhrInProgress=xhr;return deferred}function smartUpdate(container,newElements){var newTabs=newElements.querySelectorAll(".tabwrap");var oldTabs=container.find(".tabwrap");var newContents=AJS.$(newElements.querySelectorAll("#issue_actions_container")).contents();var oldContents=$tabContents.contents();if(newTabs.length&&oldTabs.length&&newContents.length&&oldContents.length){oldTabs.replaceWith(newTabs);var currentContentHeight=$tabContents.height();$tabContents.append(newContents);var newContentHeight=$tabContents.height()-currentContentHeight;var visibleHeightDifference=AJS.$(window).scrollTop()+AJS.$(window).height()-($tabContents.offset().top+newContentHeight);if(visibleHeightDifference>0){$tabContents.css("height",newContentHeight+visibleHeightDifference);oldContents.remove();var preDelay=150;setTimeout(function(){var pixelsPerSecond=500;var animSpeed=visibleHeightDifference/pixelsPerSecond*1000;$tabContents.animate({height:newContentHeight},animSpeed,"easeOutQuart",function(){$tabContents.css("height","auto")})},preDelay)}else{$tabContents.empty().append(newContents)}AJS.$(newElements.querySelectorAll("script")).each(function(){AJS.$.globalEval(this.text||this.textContent||this.innerHTML||"")})}else{container.empty().append(newElements)}}function appendHashCodeToLinks(context){AJS.$(context).find(AJAX_LINK_SELECTOR).each(function(){var $a=AJS.$(this);$a.attr("href",$a.attr("href")+"#issue-tabs")})}function processActivityModuleLinks(context){if(!useHistoryApi||AJS.$.support.pjax){enableAjaxOnLinks(context)}else{appendHashCodeToLinks(context)}}function setupMouseoverBehaviour(context){jQuery(context).bind("moveToFinished",function(event,target){jQuery("a.twixi:visible",target).focus()})}function initLivestamp(context){context.find("time.livestamp").livestamp()}function onTabReady(listener){if(jQuery.inArray(listener,issueTabLoadedListeners)<0){issueTabLoadedListeners.push(listener)}}onTabReady(bindToTabDivs);onTabReady(processActivityModuleLinks);onTabReady(setupMouseoverBehaviour);onTabReady(JIRA.userhover);onTabReady(initLivestamp);return{onTabReady:onTabReady,domReady:dispatchIssueTabLoadedEvent}})();AJS.$(function(){if(JIRA.Events.PANEL_REFRESHED){JIRA.bind(JIRA.Events.PANEL_REFRESHED,function(e,panel,$new,$existing){if(panel==="activitymodule"){var $focusedTab=$existing.find("#issue_actions_container > .issue-data-block.focused");if($focusedTab.length===1){$new.find("#"+$focusedTab.attr("id")).addClass("focused")}}})}});JIRA.bind(JIRA.Events.NEW_CONTENT_ADDED,function(event,$el){JIRA.ViewIssueTabs.domReady($el)});