define("jira/ajs/select/suggestion-collection-model",["jira/ajs/control","jira/ajs/list/group-descriptor","jira/ajs/list/item-descriptor","jira/util/objects","jquery","underscore"],function(Control,GroupDescriptor,ItemDescriptor,Objects,jQuery,_){return Control.extend({init:function(options){if(options.element){options.element=jQuery(options.element)}else{options.element=jQuery(options)}this._setOptions(options);this.$element=this.options.element.hide();this.type=this.$element.attr("data-multiple")?"multiple":"single";this.id=this.$element.attr("id")||this.$element.attr("name");this.$optionsContainer=this.$element.siblings("#"+this.id+"-options");this.selectedDescriptors=[];this.groupFilter=false;this._parseDescriptors()},_getDefaultOptions:function(){return{}},_setValue:function(){var values=this.selectedDescriptors.map(function(item){return item.value()});this.$element.val(values.join(","))},getSelectedValues:function(){var selectedVals=[];for(var i=0;i<this.selectedDescriptors.length;i++){selectedVals.push(this.selectedDescriptors[i].value())}return selectedVals},setSelected:function(descriptor,triggerChangeEvent){triggerChangeEvent=typeof triggerChangeEvent!=="undefined"?triggerChangeEvent:true;descriptor=this._descriptor(descriptor);var descriptors=_.filter(this.getAllDescriptors(false),function(item){return item.value()===descriptor.value()});if(descriptors.length===0){return false}if(this.type==="single"){if(descriptor.value()===this.getValue()){return true}this.setAllUnSelected();descriptors=descriptors.slice(0,1)}else{descriptors=_.filter(descriptors,function(item){return item.selected()!==true})}Array.prototype.push.apply(this.selectedDescriptors,descriptors);_.each(descriptors,function(item){item.selected(true)});this._setValue();descriptor.highlighted(false);if(triggerChangeEvent){this.$element.trigger("change",descriptor)}return true},setAllSelected:function(){var instance=this;jQuery(this.getDisplayableUnSelectedDescriptors()).each(function(){instance.setSelected(this)})},setAllUnSelected:function(){_.each(this.selectedDescriptors,function(descriptor){descriptor.selected(false)});this.selectedDescriptors=[];this._setValue()},setUnSelected:function(descriptor){descriptor=this._descriptor(descriptor);for(var i=0;i<this.selectedDescriptors.length;i++){if(this.selectedDescriptors[i].value()===descriptor.value()){this.selectedDescriptors[i].selected(false);this.selectedDescriptors.splice(i,1);i--}}this._setValue()},remove:function(descriptor){descriptor=this._descriptor(descriptor);for(var i=0;i<this.descriptors.length;i++){if(this.descriptors[i] instanceof GroupDescriptor){for(var j=0;j<this.descriptors[i].items().length;j++){if(this.descriptors[i].items()[j].value()===descriptor.value()){this.descriptors[i].items().splice(j,1);j--}}}else{if(this.descriptors[i].value()===descriptor.value()){this.descriptors.splice(i,1);i--}}}},getDescriptor:function(value){var returnDescriptor;value=jQuery.trim(value.toLowerCase());jQuery.each(this.getAllDescriptors(false),function(e,descriptor){if(value===jQuery.trim(descriptor.label().toLowerCase())||value===jQuery.trim(descriptor.value().toLowerCase())){returnDescriptor=descriptor;return false}});return returnDescriptor},_parseDescriptors:function(){var group,items,options=[];options=this.$optionsContainer.data("suggestions")||[];this.descriptors=[];for(var i=0;i<options.length;i++){if(typeof options[i].items!=="undefined"){group=new GroupDescriptor({label:options[i].label});items=options[i].items;for(var j=0;j<items.length;j++){var item=new ItemDescriptor(items[j]);if(item.selected()===true){if(this.type==="single"&&this.selectedDescriptors.length>0){item.selected(false)}else{this.selectedDescriptors.push(item)}}group.addItem(item)}this.descriptors.push(group)}else{item=new ItemDescriptor(options[i]);this.descriptors.push(item);if(item.selected()===true){if(this.type==="single"&&this.selectedDescriptors.length>0){item.selected(false)}else{this.selectedDescriptors.push(item)}}}}this._setValue()},getPlaceholder:function(){return this.placeholder},getValue:function(){return this.$element.val()},getDisplayableSelectedDescriptors:function(){return this.selectedDescriptors.slice()},getDisplayableUnSelectedDescriptors:function(){return _.filter(this.getAllDescriptors(false),function(item){return this.selectedDescriptors.indexOf(item)===-1}.bind(this))},getAllDescriptors:function(showGroups){var descriptors=[];if(this.groupFilter!==false){for(var key in this.descriptors){if(this.descriptors[key] instanceof GroupDescriptor&&this.descriptors[key].label()==this.groupFilter){descriptors=this.descriptors[key].items().slice()}}}else{if(showGroups===false){for(var key in this.descriptors){if(this.descriptors[key] instanceof GroupDescriptor){descriptors=descriptors.concat(this.descriptors[key].items())}else{if(this.descriptors.hasOwnProperty(key)){descriptors.push(this.descriptors[key])}}}}else{descriptors=this.descriptors.slice()}}return descriptors},clearUnSelected:function(){var instance=this;this.descriptors=_.filter(this.descriptors,function(group){if(group instanceof GroupDescriptor){group.items(_.filter(group.items(),function(item){return instance.selectedDescriptors.indexOf(item)!==-1}));return true}return instance.selectedDescriptors.indexOf(group)!==-1})},getUnSelectedDescriptors:function(){var instance=this,descriptors=[],addedValues={},selectedValues={},filterDescriptors=function(descriptor){var descriptorVal=descriptor.value().toLowerCase();if(selectedValues[descriptorVal]&&(!addedValues[descriptorVal]||descriptor.allowDuplicate()!==false)){return false}addedValues[descriptorVal]=true;return true};for(var i=0;i<this.selectedDescriptors.length;i++){selectedValues[this.selectedDescriptors[i].value().toLowerCase()]=true}_.each(this.descriptors,function(item){var properties;if(item instanceof GroupDescriptor){if(instance.groupFilter===false){properties=_.clone(item.allProperties());properties.items=_.filter(item.items(),filterDescriptors);descriptors.push(new GroupDescriptor(properties))}else{if(instance.groupFilter===item.label()){descriptors=descriptors.concat(_.filter(item.items(),filterDescriptors))}}}else{if(instance.groupFilter===false&&filterDescriptors(item)){descriptors.push(item)}}});return descriptors},setFilterGroup:function(group){for(var i=0;i<this.descriptors.length;i++){if(this.descriptors[i] instanceof GroupDescriptor){if(this.descriptors[i].label()===group){this.groupFilter=group;return true}}}return false},clearFilterGroup:function(){this.groupFilter=false},_descriptor:function(descriptor){if(typeof descriptor==="string"){descriptor=new ItemDescriptor({value:descriptor,label:descriptor})}return descriptor}})});