(function(factory){if(typeof exports=="object"){module.exports=factory(require("underscore"),require("backbone"))}else{if(typeof define=="function"&&define.amd){define(["underscore","backbone"],factory)}else{if(typeof _!=="undefined"&&typeof Backbone!=="undefined"){var oldPageableCollection=Backbone.PageableCollection;var PageableCollection=factory(_,Backbone);Backbone.PageableCollection.noConflict=function(){Backbone.PageableCollection=oldPageableCollection;return PageableCollection}}}}}(function(_,Backbone){var _extend=_.extend;var _omit=_.omit;var _clone=_.clone;var _each=_.each;var _pick=_.pick;var _contains=_.contains;var _isEmpty=_.isEmpty;var _pairs=_.pairs;var _invert=_.invert;var _isArray=_.isArray;var _isFunction=_.isFunction;var _isObject=_.isObject;var _keys=_.keys;var _isUndefined=_.isUndefined;var ceil=Math.ceil;var floor=Math.floor;var max=Math.max;var BBColProto=Backbone.Collection.prototype;function finiteInt(val,name){if(!_.isNumber(val)||_.isNaN(val)||!_.isFinite(val)||~~val!==val){throw new TypeError("`"+name+"` must be a finite integer")}return val}function queryStringToParams(qs){var kvp,k,v,ls,params={},decode=decodeURIComponent;var kvps=qs.split("&");for(var i=0,l=kvps.length;i<l;i++){var param=kvps[i];kvp=param.split("="),k=kvp[0],v=kvp[1]||true;k=decode(k),v=decode(v),ls=params[k];if(_isArray(ls)){ls.push(v)}else{if(ls){params[k]=[ls,v]}else{params[k]=v}}}return params}function runOnceAtLastHandler(col,event,func){var eventHandlers=col._events[event];if(eventHandlers&&eventHandlers.length){var lastHandler=eventHandlers[eventHandlers.length-1];var oldCallback=lastHandler.callback;lastHandler.callback=function(){try{oldCallback.apply(this,arguments);func()}catch(e){throw e}finally{lastHandler.callback=oldCallback}}}else{func()}}var PARAM_TRIM_RE=/[\s'"]/g;var URL_TRIM_RE=/[<>\s'"]/g;var PageableCollection=Backbone.PageableCollection=Backbone.Collection.extend({state:{firstPage:1,lastPage:null,currentPage:null,pageSize:25,totalPages:null,totalRecords:null,sortKey:null,order:-1},mode:"server",queryParams:{currentPage:"page",pageSize:"per_page",totalPages:"total_pages",totalRecords:"total_entries",sortKey:"sort_by",order:"order",directions:{"-1":"asc","1":"desc"}},constructor:function(models,options){BBColProto.constructor.apply(this,arguments);options=options||{};var mode=this.mode=options.mode||this.mode||PageableProto.mode;var queryParams=_extend({},PageableProto.queryParams,this.queryParams,options.queryParams||{});queryParams.directions=_extend({},PageableProto.queryParams.directions,this.queryParams.directions,queryParams.directions||{});this.queryParams=queryParams;var state=this.state=_extend({},PageableProto.state,this.state,options.state||{});state.currentPage=state.currentPage==null?state.firstPage:state.currentPage;if(!_isArray(models)){models=models?[models]:[]}models=models.slice();if(mode!="server"&&state.totalRecords==null&&!_isEmpty(models)){state.totalRecords=models.length}this.switchMode(mode,_extend({fetch:false,resetState:false,models:models},options));var comparator=options.comparator;if(state.sortKey&&!comparator){this.setSorting(state.sortKey,state.order,options)}if(mode!="server"){var fullCollection=this.fullCollection;if(comparator&&options.full){this.comparator=null;fullCollection.comparator=comparator}if(options.full){fullCollection.sort()}if(models&&!_isEmpty(models)){this.reset(models,_extend({silent:true},options));this.getPage(state.currentPage);models.splice.apply(models,[0,models.length].concat(this.models))}}this._initState=_clone(this.state)},_makeFullCollection:function(models,options){var properties=["url","model","sync","comparator"];var thisProto=this.constructor.prototype;var i,length,prop;var proto={};for(i=0,length=properties.length;i<length;i++){prop=properties[i];if(!_isUndefined(thisProto[prop])){proto[prop]=thisProto[prop]}}var fullCollection=new (Backbone.Collection.extend(proto))(models,options);for(i=0,length=properties.length;i<length;i++){prop=properties[i];if(this[prop]!==thisProto[prop]){fullCollection[prop]=this[prop]}}return fullCollection},_makeCollectionEventHandler:function(pageCol,fullCol){return function collectionEventHandler(event,model,collection,options){var handlers=pageCol._handlers;_each(_keys(handlers),function(event){var handler=handlers[event];pageCol.off(event,handler);fullCol.off(event,handler)});var state=_clone(pageCol.state);var firstPage=state.firstPage;var currentPage=firstPage===0?state.currentPage:state.currentPage-1;var pageSize=state.pageSize;var pageStart=currentPage*pageSize,pageEnd=pageStart+pageSize;if(event=="add"){var pageIndex,fullIndex,addAt,colToAdd,options=options||{};if(collection==fullCol){fullIndex=fullCol.indexOf(model);if(fullIndex>=pageStart&&fullIndex<pageEnd){colToAdd=pageCol;pageIndex=addAt=fullIndex-pageStart}}else{pageIndex=pageCol.indexOf(model);fullIndex=pageStart+pageIndex;colToAdd=fullCol;var addAt=!_isUndefined(options.at)?options.at+pageStart:fullIndex}if(!options.onRemove){++state.totalRecords;delete options.onRemove}pageCol.state=pageCol._checkState(state);if(colToAdd){colToAdd.add(model,_extend({},options||{},{at:addAt}));var modelToRemove=pageIndex>=pageSize?model:!_isUndefined(options.at)&&addAt<pageEnd&&pageCol.length>pageSize?pageCol.at(pageSize):null;if(modelToRemove){runOnceAtLastHandler(collection,event,function(){pageCol.remove(modelToRemove,{onAdd:true})})}}}if(event=="remove"){if(!options.onAdd){if(!--state.totalRecords){state.totalRecords=null;state.totalPages=null}else{var totalPages=state.totalPages=ceil(state.totalRecords/pageSize);state.lastPage=firstPage===0?totalPages-1:totalPages||firstPage;if(state.currentPage>totalPages){state.currentPage=state.lastPage}}pageCol.state=pageCol._checkState(state);var nextModel,removedIndex=options.index;if(collection==pageCol){if(nextModel=fullCol.at(pageEnd)){runOnceAtLastHandler(pageCol,event,function(){pageCol.push(nextModel,{onRemove:true})})}else{if(!pageCol.length&&state.totalRecords){pageCol.reset(fullCol.models.slice(pageStart-pageSize,pageEnd-pageSize),_extend({},options,{parse:false}))}}fullCol.remove(model)}else{if(removedIndex>=pageStart&&removedIndex<pageEnd){if(nextModel=fullCol.at(pageEnd-1)){runOnceAtLastHandler(pageCol,event,function(){pageCol.push(nextModel,{onRemove:true})})}pageCol.remove(model);if(!pageCol.length&&state.totalRecords){pageCol.reset(fullCol.models.slice(pageStart-pageSize,pageEnd-pageSize),_extend({},options,{parse:false}))}}}}else{delete options.onAdd}}if(event=="reset"){options=collection;collection=model;if(collection==pageCol&&options.from==null&&options.to==null){var head=fullCol.models.slice(0,pageStart);var tail=fullCol.models.slice(pageStart+pageCol.models.length);fullCol.reset(head.concat(pageCol.models).concat(tail),options)}else{if(collection==fullCol){if(!(state.totalRecords=fullCol.models.length)){state.totalRecords=null;state.totalPages=null}if(pageCol.mode=="client"){state.lastPage=state.currentPage=state.firstPage}pageCol.state=pageCol._checkState(state);pageCol.reset(fullCol.models.slice(pageStart,pageEnd),_extend({},options,{parse:false}))}}}if(event=="sort"){options=collection;collection=model;if(collection===fullCol){pageCol.reset(fullCol.models.slice(pageStart,pageEnd),_extend({},options,{parse:false}))}}_each(_keys(handlers),function(event){var handler=handlers[event];_each([pageCol,fullCol],function(col){col.on(event,handler);var callbacks=col._events[event]||[];callbacks.unshift(callbacks.pop())})})}},_checkState:function(state){var mode=this.mode;var links=this.links;var totalRecords=state.totalRecords;var pageSize=state.pageSize;var currentPage=state.currentPage;var firstPage=state.firstPage;var totalPages=state.totalPages;if(totalRecords!=null&&pageSize!=null&&currentPage!=null&&firstPage!=null&&(mode=="infinite"?links:true)){totalRecords=finiteInt(totalRecords,"totalRecords");pageSize=finiteInt(pageSize,"pageSize");currentPage=finiteInt(currentPage,"currentPage");firstPage=finiteInt(firstPage,"firstPage");if(pageSize<1){throw new RangeError("`pageSize` must be >= 1")}totalPages=state.totalPages=ceil(totalRecords/pageSize);if(firstPage<0||firstPage>1){throw new RangeError("`firstPage must be 0 or 1`")}state.lastPage=firstPage===0?max(0,totalPages-1):totalPages||firstPage;if(mode=="infinite"){if(!links[currentPage+""]){throw new RangeError("No link found for page "+currentPage)}}else{if(currentPage<firstPage||(totalPages>0&&(firstPage?currentPage>totalPages:currentPage>=totalPages))){throw new RangeError("`currentPage` must be firstPage <= currentPage "+(firstPage?">":">=")+" totalPages if "+firstPage+"-based. Got "+currentPage+".")}}}return state},setPageSize:function(pageSize,options){pageSize=finiteInt(pageSize,"pageSize");options=options||{first:false};var state=this.state;var totalPages=ceil(state.totalRecords/pageSize);var currentPage=totalPages?max(state.firstPage,floor(totalPages*state.currentPage/state.totalPages)):state.firstPage;state=this.state=this._checkState(_extend({},state,{pageSize:pageSize,currentPage:options.first?state.firstPage:currentPage,totalPages:totalPages}));return this.getPage(state.currentPage,_omit(options,["first"]))},switchMode:function(mode,options){if(!_contains(["server","client","infinite"],mode)){throw new TypeError('`mode` must be one of "server", "client" or "infinite"')}options=options||{fetch:true,resetState:true};var state=this.state=options.resetState?_clone(this._initState):this._checkState(_extend({},this.state));this.mode=mode;var self=this;var fullCollection=this.fullCollection;var handlers=this._handlers=this._handlers||{},handler;if(mode!="server"&&!fullCollection){fullCollection=this._makeFullCollection(options.models||[],options);fullCollection.pageableCollection=this;this.fullCollection=fullCollection;var allHandler=this._makeCollectionEventHandler(this,fullCollection);_each(["add","remove","reset","sort"],function(event){handlers[event]=handler=_.bind(allHandler,{},event);self.on(event,handler);fullCollection.on(event,handler)});fullCollection.comparator=this._fullComparator}else{if(mode=="server"&&fullCollection){_each(_keys(handlers),function(event){handler=handlers[event];self.off(event,handler);fullCollection.off(event,handler)});delete this._handlers;this._fullComparator=fullCollection.comparator;delete this.fullCollection}}if(mode=="infinite"){var links=this.links={};var firstPage=state.firstPage;var totalPages=ceil(state.totalRecords/state.pageSize);var lastPage=firstPage===0?max(0,totalPages-1):totalPages||firstPage;for(var i=state.firstPage;i<=lastPage;i++){links[i]=this.url}}else{if(this.links){delete this.links}}return options.fetch?this.fetch(_omit(options,"fetch","resetState")):this},hasPreviousPage:function(){var state=this.state;var currentPage=state.currentPage;if(this.mode!="infinite"){return currentPage>state.firstPage}return !!this.links[currentPage-1]},hasNextPage:function(){var state=this.state;var currentPage=this.state.currentPage;if(this.mode!="infinite"){return currentPage<state.lastPage}return !!this.links[currentPage+1]},getFirstPage:function(options){return this.getPage("first",options)},getPreviousPage:function(options){return this.getPage("prev",options)},getNextPage:function(options){return this.getPage("next",options)},getLastPage:function(options){return this.getPage("last",options)},getPage:function(index,options){var mode=this.mode,fullCollection=this.fullCollection;options=options||{fetch:false};var state=this.state,firstPage=state.firstPage,currentPage=state.currentPage,lastPage=state.lastPage,pageSize=state.pageSize;var pageNum=index;switch(index){case"first":pageNum=firstPage;break;case"prev":pageNum=currentPage-1;break;case"next":pageNum=currentPage+1;break;case"last":pageNum=lastPage;break;default:pageNum=finiteInt(index,"index")}this.state=this._checkState(_extend({},state,{currentPage:pageNum}));options.from=currentPage,options.to=pageNum;var pageStart=(firstPage===0?pageNum:pageNum-1)*pageSize;var pageModels=fullCollection&&fullCollection.length?fullCollection.models.slice(pageStart,pageStart+pageSize):[];if((mode=="client"||(mode=="infinite"&&!_isEmpty(pageModels)))&&!options.fetch){this.reset(pageModels,_omit(options,"fetch"));return this}if(mode=="infinite"){options.url=this.links[pageNum]}return this.fetch(_omit(options,"fetch"))},getPageByOffset:function(offset,options){if(offset<0){throw new RangeError("`offset must be > 0`")}offset=finiteInt(offset);var page=floor(offset/this.state.pageSize);if(this.state.firstPage!==0){page++}if(page>this.state.lastPage){page=this.state.lastPage}return this.getPage(page,options)},sync:function(method,model,options){var self=this;if(self.mode=="infinite"){var success=options.success;var currentPage=self.state.currentPage;options.success=function(resp,status,xhr){var links=self.links;var newLinks=self.parseLinks(resp,_extend({xhr:xhr},options));if(newLinks.first){links[self.state.firstPage]=newLinks.first}if(newLinks.prev){links[currentPage-1]=newLinks.prev}if(newLinks.next){links[currentPage+1]=newLinks.next}if(success){success(resp,status,xhr)}}}return(BBColProto.sync||Backbone.sync).call(self,method,model,options)},parseLinks:function(resp,options){var links={};var linkHeader=options.xhr.getResponseHeader("Link");if(linkHeader){var relations=["first","prev","next"];_each(linkHeader.split(","),function(linkValue){var linkParts=linkValue.split(";");var url=linkParts[0].replace(URL_TRIM_RE,"");var params=linkParts.slice(1);_each(params,function(param){var paramParts=param.split("=");var key=paramParts[0].replace(PARAM_TRIM_RE,"");var value=paramParts[1].replace(PARAM_TRIM_RE,"");if(key=="rel"&&_contains(relations,value)){links[value]=url}})})}return links},parse:function(resp,options){var newState=this.parseState(resp,_clone(this.queryParams),_clone(this.state),options);if(newState){this.state=this._checkState(_extend({},this.state,newState))}return this.parseRecords(resp,options)},parseState:function(resp,queryParams,state,options){if(resp&&resp.length===2&&_isObject(resp[0])&&_isArray(resp[1])){var newState=_clone(state);var serverState=resp[0];_each(_pairs(_omit(queryParams,"directions")),function(kvp){var k=kvp[0],v=kvp[1];var serverVal=serverState[v];if(!_isUndefined(serverVal)&&!_.isNull(serverVal)){newState[k]=serverState[v]}});if(serverState.order){newState.order=_invert(queryParams.directions)[serverState.order]*1}return newState}},parseRecords:function(resp,options){if(resp&&resp.length===2&&_isObject(resp[0])&&_isArray(resp[1])){return resp[1]}return resp},fetch:function(options){options=options||{};var state=this._checkState(this.state);var mode=this.mode;if(mode=="infinite"&&!options.url){options.url=this.links[state.currentPage]}var data=options.data||{};var url=options.url||this.url||"";if(_isFunction(url)){url=url.call(this)}var qsi=url.indexOf("?");if(qsi!=-1){_extend(data,queryStringToParams(url.slice(qsi+1)));url=url.slice(0,qsi)}options.url=url;options.data=data;var queryParams=this.mode=="client"?_pick(this.queryParams,"sortKey","order"):_omit(_pick(this.queryParams,_keys(PageableProto.queryParams)),"directions");var i,kvp,k,v,kvps=_pairs(queryParams),thisCopy=_clone(this);for(i=0;i<kvps.length;i++){kvp=kvps[i],k=kvp[0],v=kvp[1];v=_isFunction(v)?v.call(thisCopy):v;if(state[k]!=null&&v!=null){data[v]=state[k]}}if(state.sortKey&&state.order){var o=_isFunction(queryParams.order)?queryParams.order.call(thisCopy):queryParams.order;data[o]=this.queryParams.directions[state.order+""]}else{if(!state.sortKey){delete data[queryParams.order]}}var extraKvps=_pairs(_omit(this.queryParams,_keys(PageableProto.queryParams)));for(i=0;i<extraKvps.length;i++){kvp=extraKvps[i];v=kvp[1];v=_isFunction(v)?v.call(thisCopy):v;if(v!=null){data[kvp[0]]=v}}if(mode!="server"){var self=this,fullCol=this.fullCollection;var success=options.success;options.success=function(col,resp,opts){opts=opts||{};if(_isUndefined(options.silent)){delete opts.silent}else{opts.silent=options.silent}var models=col.models;if(mode=="client"){fullCol.reset(models,opts)}else{fullCol.add(models,_extend({at:fullCol.length},_extend(opts,{parse:false})));self.trigger("reset",self,opts)}if(success){success(col,resp,opts)}};return BBColProto.fetch.call(this,_extend({},options,{silent:true}))}return BBColProto.fetch.call(this,options)},_makeComparator:function(sortKey,order,sortValue){var state=this.state;sortKey=sortKey||state.sortKey;order=order||state.order;if(!sortKey||!order){return }if(!sortValue){sortValue=function(model,attr){return model.get(attr)}}return function(left,right){var l=sortValue(left,sortKey),r=sortValue(right,sortKey),t;if(order===1){t=l,l=r,r=t}if(l===r){return 0}else{if(l<r){return -1}}return 1}},setSorting:function(sortKey,order,options){var state=this.state;state.sortKey=sortKey;state.order=order=order||state.order;var fullCollection=this.fullCollection;var delComp=false,delFullComp=false;if(!sortKey){delComp=delFullComp=true}var mode=this.mode;options=_extend({side:mode=="client"?mode:"server",full:true},options);var comparator=this._makeComparator(sortKey,order,options.sortValue);var full=options.full,side=options.side;if(side=="client"){if(full){if(fullCollection){fullCollection.comparator=comparator}delComp=true}else{this.comparator=comparator;delFullComp=true}}else{if(side=="server"&&!full){this.comparator=comparator}}if(delComp){this.comparator=null}if(delFullComp&&fullCollection){fullCollection.comparator=null}return this}});var PageableProto=PageableCollection.prototype;return PageableCollection}));