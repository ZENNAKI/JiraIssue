/* THIS FILE HAS BEEN MODIFIED BY ATLASSIAN, SEE https://github.com/jhudson8/backbone-query-parameters/pull/63/files */
(function(root,factory){if(typeof exports==="object"&&root.require){module.exports=factory(require("underscore"),require("backbone"))}else{if(typeof define==="function"&&define.amd){define(["underscore","backbone"],function(_,Backbone){return factory(_||root._,Backbone||root.Backbone)})}else{factory(_,Backbone)}}}(this,function(_,Backbone){var queryStringParam=/^\?(.*)/,optionalParam=/\((.*?)\)/g,namedParam=/(\(\?)?:\w+/g,splatParam=/\*\w+/g,escapeRegExp=/[\-{}\[\]+?.,\\\^$|#\s]/g,fragmentStrip=/^([^\?]*)/,namesPattern=/[\:\*]([^\:\?\/]+)/g,routeStripper=/^[#\/]|\s+$/g,trailingSlash=/\/$/;Backbone.Router.arrayValueSplit="|";var _getFragment=function(fragment,forcePushState){if(fragment==null){if(this._hasPushState||!this._wantsHashChange||forcePushState){fragment=this.location.pathname;var root=this.root.replace(trailingSlash,"");var search=this.location.search;if(!fragment.indexOf(root)){fragment=fragment.substr(root.length)}if(search){fragment+=search}}else{fragment=this.getHash()}}return fragment.replace(routeStripper,"")};function proxy(source,proxy,name){_.each(Array.prototype.slice.call(arguments,2),function(name){Object.defineProperty(proxy,name,{get:function(){return source[name]},set:function(value){source[name]=value}})})}proxy.isSupported=(function(){try{Object.defineProperty({},"x",{});return true}catch(e){return false}})();function LocationRewriter(history){var original=history.location,replacement={};proxy(original,replacement,"assign","ancestorOrigins","origin","hash","search","pathname","port","hostname","host","protocol","href","reload");replacement.replace=function(){original.replace(history.root+"#"+history.fragment)};replacement.unPatch=function(){return history.location=original};history.location=replacement}function HistoryRewriter(history){var original=history.history,replacement={};proxy(original,replacement,"length","state","back","forward","go","pushState");replacement.replaceState=function(state,title,url){url=history.root+history.fragment;return original.replaceState(state,title,url)};replacement.unPatch=function(){history.history=original};history.history=replacement}var _start=Backbone.History.prototype.start,_loadUrl=Backbone.History.prototype.loadUrl;_.extend(Backbone.History.prototype,{getFragment:_getFragment,getQueryParameters:function(fragment,forcePushState){fragment=_getFragment.apply(this,arguments);var queryString=fragment.replace(fragmentStrip,"");var match=queryString.match(queryStringParam);if(match){queryString=match[1];var rtn={};iterateQueryString(queryString,function(name,value){value=value.replace(/\+/g,"%20");value=decodeURIComponent(value);if(!rtn[name]){rtn[name]=value}else{if(_.isString(rtn[name])){rtn[name]=[rtn[name],value]}else{rtn[name].push(value)}}});return rtn}else{return{}}},start:function(){if(proxy.isSupported){LocationRewriter(this);HistoryRewriter(this)}try{return _start.apply(this,arguments)}finally{this.location.unPatch&&this.location.unPatch();this.history.unPatch&&this.history.unPatch()}},loadUrl:function(){this.location&&this.location.unPatch&&this.location.unPatch();this.history&&this.history.unPatch&&this.history.unPatch();return _loadUrl.apply(this,arguments)}});_.extend(Backbone.Router.prototype,{initialize:function(options){this.encodedSplatParts=options&&options.encodedSplatParts},getFragment:_getFragment,_routeToRegExp:function(route){var splatMatch=(splatParam.exec(route)||{index:-1}),namedMatch=(namedParam.exec(route)||{index:-1}),paramNames=route.match(namesPattern)||[];route=route.replace(escapeRegExp,"\\$&").replace(optionalParam,"(?:$1)?").replace(namedParam,function(match,optional){return optional?match:"([^\\/\\?]+)"}).replace(splatParam,"([^??]*?)");route+="(\\?.*)?";var rtn=new RegExp("^"+route+"$");if(splatMatch.index>=0){if(namedMatch>=0){rtn.splatMatch=splatMatch.index-namedMatch.index}else{rtn.splatMatch=-1}}rtn.paramNames=_.map(paramNames,function(name){return name.substring(1)});rtn.namedParameters=this.namedParameters;return rtn},_extractParameters:function(route,fragment){var params=route.exec(fragment).slice(1),namedParams={};if(params.length>0&&_.isUndefined(params[params.length-1])){params.splice(params.length-1,1)}var match=params.length&&params[params.length-1]&&params[params.length-1].match(queryStringParam);if(match){var queryString=match[1];var data={};if(queryString){var self=this;iterateQueryString(queryString,function(name,value){self._setParamValue(name,value,data)})}params[params.length-1]=data;_.extend(namedParams,data)}var length=params.length;if(route.splatMatch&&this.encodedSplatParts){if(route.splatMatch<0){return params}else{length=length-1}}for(var i=0;i<length;i++){if(_.isString(params[i])){params[i]=decodeURIComponent(params[i]);if(route.paramNames&&route.paramNames.length>=i-1){namedParams[route.paramNames[i]]=params[i]}}}return(Backbone.Router.namedParameters||route.namedParameters)?[namedParams]:params},_setParamValue:function(key,value,data){key=key.replace("[]","");var parts=key.split(".");var _data=data;for(var i=0;i<parts.length;i++){var part=parts[i];if(i===parts.length-1){_data[part]=this._decodeParamValue(value,_data[part])}else{_data=_data[part]=_data[part]||{}}}},_decodeParamValue:function(value,currentValue){value=value.replace(/\+/g,"%20");var splitChar=Backbone.Router.arrayValueSplit;if(splitChar&&value.indexOf(splitChar)>=0){var values=value.split(splitChar);for(var i=values.length-1;i>=0;i--){if(!values[i]){values.splice(i,1)}else{values[i]=decodeURIComponent(values[i])}}return values}value=decodeURIComponent(value);if(!currentValue){return value}else{if(_.isArray(currentValue)){currentValue.push(value);return currentValue}else{return[currentValue,value]}}},toFragment:function(route,queryParameters){if(queryParameters){if(!_.isString(queryParameters)){queryParameters=this._toQueryString(queryParameters)}if(queryParameters){route+="?"+queryParameters}}return route},_toQueryString:function(val,namePrefix){var splitChar=Backbone.Router.arrayValueSplit;function encodeSplit(val){return String(val).replace(splitChar,encodeURIComponent(splitChar))}if(!val){return""}namePrefix=namePrefix||"";var rtn="";for(var name in val){var _val=val[name];if(_.isString(_val)||_.isNumber(_val)||_.isBoolean(_val)||_.isDate(_val)){_val=this._toQueryParam(_val);if(_.isBoolean(_val)||_.isNumber(_val)||_.isString(_val)||_val){rtn+=(rtn?"&":"")+this._toQueryParamName(name,namePrefix)+"="+encodeSplit(encodeURIComponent(_val))}}else{if(_.isArray(_val)){var str="";for(var i=0;i<_val.length;i++){var param=this._toQueryParam(_val[i]);if(_.isBoolean(param)||param!==null){str+=splitChar+encodeSplit(param)}}if(str){rtn+=(rtn?"&":"")+this._toQueryParamName(name,namePrefix)+"="+str}}else{var result=this._toQueryString(_val,this._toQueryParamName(name,namePrefix,true));if(result){rtn+=(rtn?"&":"")+result}}}}return rtn},_toQueryParamName:function(name,prefix,isPrefix){return(prefix+name+(isPrefix?".":""))},_toQueryParam:function(param){if(_.isNull(param)||_.isUndefined(param)){return null}return param}});function iterateQueryString(queryString,callback){var keyValues=queryString.split("&");_.each(keyValues,function(keyValue){var arr=keyValue.split("=");callback(arr.shift(),arr.join("="))})}}));