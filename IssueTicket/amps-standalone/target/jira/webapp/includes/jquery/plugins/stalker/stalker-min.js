(function(){var containDropdown=require("jira/dropdown/contain-dropdown");var Elements=require("jira/util/elements");var Navigator=require("jira/util/navigator");var jQuery=require("jquery");jQuery.fn.stalker=function(){var $win=jQuery(window),$doc=jQuery(document),$stalkerContent,$stalker,$transitionElems,offsetY,placeholder,lastScrollPosY,stalkerHeight,selector=this.selector;function getScrollTop(scrollPos){return Math.max(0,jQuery(window).scrollTop(scrollPos))}function supportsOpacityTransition(){return true}function getInactiveProperties(){return{position:"fixed",top:offsetY-getScrollTop()}}function initialize(){$stalker=jQuery(selector);if($stalker.length===0||$stalker.data("stalkerIntialized")){return }$stalker.data("stalkerIntialized",true);$doc.bind("keydown",function(event){if(Elements.consumesKeyboardEvents(jQuery(event.target))){return }var handler;switch(event.keyCode){case jQuery.ui.keyCode.SPACE:handler=(event.shiftKey)?pageUp:pageDown;break;case jQuery.ui.keyCode.PAGE_UP:handler=pageUp;break;case jQuery.ui.keyCode.PAGE_DOWN:handler=pageDown;break;default:return }if(jQuery("body").css("overflow")!=="hidden"){handler()}event.preventDefault()});offsetY=$stalker.offset().top;$stalkerContent=$stalker.find(".issue-header-content");$transitionElems=jQuery("#header");function setStalkerHeight(){$stalker.css("overflow","hidden");stalkerHeight=$stalker.outerHeight();$stalker.css("overflow","")}function createPlaceholder(){placeholder=jQuery("<div />").addClass("stalker-placeholder").css({visibility:"hidden",height:stalkerHeight}).insertBefore($stalker)}function setPlaceholderHeight(){placeholder.height($stalkerContent.outerHeight())}setStalkerHeight();createPlaceholder();setPlaceholderHeight();$stalker.css(getInactiveProperties());$stalker.bind("stalkerHeightUpdated",setPlaceholderHeight);$stalker.bind("positionChanged",setStalkerPosition)}function setScrollPostion(scrollTarget){var docHeight=jQuery.getDocHeight(),scrollPos;if(scrollTarget>=0&&scrollTarget<=docHeight){scrollPos=scrollTarget}else{if(scrollTarget>=getScrollTop()){scrollPos=docHeight}else{if(scrollTarget<0){scrollPos=0}}}getScrollTop(scrollPos)}function pageUp(){initialize();var scrollTarget=getScrollTop()-jQuery(window).height();setScrollPostion(scrollTarget+stalkerHeight)}function pageDown(){initialize();var scrollTarget=getScrollTop()+jQuery(window).height();setScrollPostion(scrollTarget-stalkerHeight)}function containDropdownsInWindow(){$doc.bind("showLayer",function(e,type,obj){var stalkerOffset,targetHeight;initialize();if(type==="dropdown"&&obj.$.parents(selector).length!==-1){stalkerOffset=($stalker.hasClass("detached")||!$stalker.offset()?0:$stalker.offset().top);targetHeight=jQuery(window).height()-$stalker.height()-stalkerOffset;if(targetHeight<=parseInt(obj.$.prop("scrollHeight"),10)){containDropdown.containHeight(obj,targetHeight)}else{containDropdown.releaseContainment(obj)}obj.reset()}})}if(Navigator.isIE()&&Navigator.majorVersion()<11){jQuery(setup);jQuery(setStalkerPosition)}else{setup()}function setup(){containDropdownsInWindow();$doc.click(function(e){if(jQuery(e.target).parents(selector).length!==0){initialize()}});$doc.bind("showLayer",function(e,type,obj){if(obj&&$transitionElems&&supportsOpacityTransition()){var $offsetTarget=obj.$offsetTarget||obj.trigger;if($offsetTarget&&$offsetTarget[0]){for(var i=0;i<$transitionElems.length;i++){if($transitionElems[i]===$offsetTarget[0]||jQuery.contains($transitionElems[i],$offsetTarget[0])){$transitionElems.css("opacity","");break}}}else{if(obj.id==="create_issue_popup"){$transitionElems.css("opacity","")}}}if(Navigator.isMozilla()&&type==="popup"){setStalkerPosition()}});$win.scroll(setStalkerPosition);$win.resize(function(){if($stalker){$stalker.trigger("stalkerHeightUpdated")}})}function setStalkerPosition(){function getOpacitySetting(){var opacityTarget=1-getScrollTop()/offsetY;if(opacityTarget>1){return""}else{if(opacityTarget<0){return 0}else{return opacityTarget}}}initialize();if(supportsOpacityTransition()&&$transitionElems){$transitionElems.css("opacity",getOpacitySetting())}if(offsetY<=getScrollTop()){if(!$stalker.hasClass("detached")){$stalker.css({top:0,position:"fixed"}).addClass("detached")}}else{$stalker.css(getInactiveProperties()).removeClass("detached")}lastScrollPosY=getScrollTop()}return this}})();