define("jira/setup/setup-mac-util",["jquery","underscore"],function($,_){var productBundleKeys={"DEVELOPMENT":"com.pyxis.greenhopper.jira","SERVICEDESK":"com.atlassian.servicedesk"};var encode_utf8=function(s){return unescape(encodeURIComponent(s))};var encodeRequestBody=function(obj){var charmap="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789-_";var str=encode_utf8(JSON.stringify(obj))+"  ";var result=[];for(var i=0;i+2<str.length;i+=3){var threech=0;for(var j=0;j<3;++j){threech=(threech<<8)+str.charCodeAt(i+j)}for(var j=3;j>=0;--j){var chpart=(threech>>(6*j))&63;result.push(charmap.charAt(chpart))}}return result.join("")};var browserSupportsCORS=_.once(function(){return"withCredentials" in new XMLHttpRequest()});var lassoDevModeUrl="https://id.stg.internal.atlassian.com/";var getLassoURL=function(){return AJS.isDevMode()?lassoDevModeUrl:"https://id.atlassian.com/"};var hamletDevModeUrl="https://hamlet.stg.intsys.atlassian.com/";var getHamletUrl=function(){return AJS.isDevMode()?hamletDevModeUrl:"https://hamlet.atlassian.com/"};var performRequest=function(reqData,xsrfToken){var deferred=$.Deferred();var request;var requestTimeout=20000;if(browserSupportsCORS()){request=AJS.$.ajax({beforeSend:function(xhr){if(xsrfToken){xhr.setRequestHeader("ATL-XSRF-Token",xsrfToken)}},contentType:"application/json; charset=utf-8",data:reqData.data?JSON.stringify(reqData.data):undefined,dataType:"json",timeout:requestTimeout,type:reqData.type,url:reqData.url,xhrFields:{withCredentials:true}})}else{request=AJS.$.ajax({data:{method:reqData.type,"h-ATL-XSRF-Token":xsrfToken?xsrfToken:undefined,"h-Content-Type":"application/json",body:reqData.data?encodeRequestBody(reqData.data):undefined},contentType:"application/json",dataType:"jsonp",jsonp:"jsonp",timeout:requestTimeout,type:"GET",url:reqData.url}).pipe(function(dataObjects,textStatus,jqXHR){if(dataObjects[0].status!==200){return $.Deferred().rejectWith(this,[jqXHR,dataObjects[1]])}else{return $.Deferred().resolveWith(this,[dataObjects[1],textStatus,jqXHR])}},function(jqXHR){return $.Deferred().rejectWith(this,[jqXHR,{}])})}request.done(function(data,textStatus,jqXHR){deferred.resolve(data,jqXHR)});request.fail(function(jqXHR,data){var json;if(_.isObject(data)){json=data}else{try{json=JSON.parse(jqXHR.responseText)}catch(e){json={}}}deferred.reject(json,jqXHR)});return deferred.promise()};var Util=function(){this._bundleLicense=undefined;this._jiraLicense=undefined;this._userData={};this._xsrfToken=undefined};Util.prototype.setDevModeLassoUrl=function(url){lassoDevModeUrl=url};Util.prototype.setDevModeHamletUrl=function(url){hamletDevModeUrl=url};Util.prototype.checkIfUserExists=function(email){var deferred=$.Deferred();var request=performRequest({type:"GET",url:getLassoURL()+"profile/rest/user/"+encodeURIComponent(email)});request.done(function(response){if(response.exists===true){deferred.resolve(true)}else{if(response.exists===false){deferred.resolve(false)}else{deferred.reject()}}});request.fail(function(){deferred.reject()});return deferred.promise()};Util.prototype.createUser=function(data){var deferred=$.Deferred();var request=performRequest({data:{"email":data.email,"displayName":data.fullname,"password":data.password},type:"POST",url:getLassoURL()+"profile/rest/signUp"});request.done(_.bind(function(response){this._userData={email:response.username,fullname:data.fullname,password:data.password};this._xsrfToken=response.xsrfToken;deferred.resolve()},this));request.fail(function(response){deferred.reject(response)});return deferred.promise()};Util.prototype.loginUser=function(credentials){var deferred=$.Deferred();var request=performRequest({data:{"username":credentials.email,"password":credentials.password},type:"POST",url:getLassoURL()+"id/rest/login"});request.done(_.bind(function(response){this._userData={email:response.username,fullname:response.firstName+" "+response.lastName,password:credentials.password};this._xsrfToken=response.xsrfToken;deferred.resolve()},this));request.fail(function(response){deferred.reject(response)});return deferred.promise()};Util.prototype.generateEvaluationLicense=function(){var deferred=$.Deferred();if(this._jiraLicense){deferred.resolve();return deferred.promise()}var request=performRequest({data:{"productKey":"jira","serverId":AJS.Meta.get("server-id")},type:"POST",url:getHamletUrl()+"1.0/public/license/createEvaluation"},this._xsrfToken);request.done(_.bind(function(response){this._jiraLicense=response.licenseKey;deferred.resolve()},this));request.fail(function(){deferred.reject()});return deferred.promise()};Util.prototype.generateBundleEvaluationLicense=function(){var deferred=$.Deferred();var productBundle=this.getChosenBundle();if(this.isBundleChosen()){if(this._bundleLicense){deferred.resolve();return deferred.promise()}var request=performRequest({data:{"productKey":productBundleKeys[productBundle],"serverId":AJS.Meta.get("server-id")},type:"POST",url:getHamletUrl()+"1.0/public/license/createEvaluation"},this._xsrfToken);request.done(_.bind(function(response){this._bundleLicense=response.licenseKey;deferred.resolve()},this));request.fail(function(){deferred.reject()})}else{deferred.reject()}return deferred.promise()};Util.prototype.getChosenBundle=function(){return AJS.Meta.get("setup-chosen-bundle")};Util.prototype.getChosenBundleName=function(){return AJS.Meta.get("setup-chosen-bundle-name")};Util.prototype.isBundleChosen=function(){var productBundle=this.getChosenBundle();return productBundle in productBundleKeys};Util.prototype.getBundleLicense=function(){return this._bundleLicense};Util.prototype.getJiraLicense=function(){return this._jiraLicense};Util.prototype.getUserData=function(){return this._userData};var errorMessages={"Login is not possible as your email address is not verified yet.":"accountNeedsVerificationMessage","You will be temporarily blocked for five minutes due to excessive login attempts.":"accountBlockedMessage","The email address or password you entered is incorrect.":"credentialsIncorrect"};Util.prototype.transformAIDErrorMessage=function(aidMessage){if(aidMessage in errorMessages){var messageTemplateName=errorMessages[aidMessage];var messageTemplate=JIRA.Templates.Setup[messageTemplateName];return typeof (messageTemplate)==="function"?new soydata.SanitizedHtml(messageTemplate()):aidMessage}else{return aidMessage}};Util.prototype.isUserAlreadyExistsErrorMessage=function(message){return message==="A user with that email already exists"};Util.prototype.isEmailNotVerifiedErrorMessage=function(message){return message==="Login is not possible as your email address is not verified yet."};var emailRegex=/^[a-zA-Z0-9.!#$%'*+/=?^_`{|}~-]+@[a-zA-Z0-9](?:[a-zA-Z0-9-]{0,61}[a-zA-Z0-9])?(?:\.[a-zA-Z0-9](?:[a-zA-Z0-9-]{0,61}[a-zA-Z0-9])?)*$/;Util.prototype.validateEmail=function(email){if(email.length>255){return false}return emailRegex.test(email)};return Util});